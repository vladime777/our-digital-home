<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Our Little Digital Home ‚Äî Deluxe (All the extras!)</title>
  <style>
    :root {
      --sky:#dff4ff; --peach:#ffe2d2; --pink:#ffd7e9; --cream:#fff9f2; --paper:#ffffff;
      --muted:#6b6b6b; --vishnu-pink:#ffd1e6; --thanya-blue:#cfefff; --ink:#222;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,var(--sky),var(--peach),var(--pink),var(--cream));color:var(--ink);overflow-x:hidden}

    /* Loader */
    #loader{position:fixed;inset:0;background:linear-gradient(180deg,var(--sky),var(--peach),var(--pink),var(--cream));display:flex;align-items:center;justify-content:center;z-index:9990}
    @keyframes pulseHeart{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}
    .heart{width:84px;height:84px;background:pink;position:relative;transform:rotate(-45deg);animation:pulseHeart 1.1s infinite}
    .heart:before,.heart:after{content:"";position:absolute;background:pink;width:84px;height:84px;border-radius:50%}
    .heart:before{top:-42px}.heart:after{left:42px}
    .fade-out{animation:fadeOut .8s ease forwards}
    @keyframes fadeOut{to{opacity:0;visibility:hidden}}

    /* Stars canvas */
    #stars{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;z-index:1;pointer-events:none;background:transparent;display:block}
    .petal,.cursor-heart{position:fixed;pointer-events:none;z-index:2}

    /* Lock Screen */
    #lockScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,var(--pink),var(--peach),var(--sky))}
    .lock-card{background:rgba(255,255,255,.7);padding:26px 28px;border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.12);backdrop-filter:blur(10px);text-align:center}
    .lock-card h2{margin-bottom:8px}
    .lock-card input{padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:18px;text-align:center;width:180px}
    .lock-card button{margin-top:12px;background:linear-gradient(90deg,var(--sky),var(--pink));border:none;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .lock-meta{font-size:12px;color:#666;margin-top:8px}
    .shake{animation:shake .4s}
    @keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-8px)}40%,60%{transform:translateX(8px)}}

    /* Floating Nav */
    #floatNav{position:fixed;top:14px;right:14px;z-index:998;backdrop-filter:blur(10px);background:rgba(255,255,255,.6);padding:8px 10px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:6px}
    #floatNav a{text-decoration:none;font-size:20px}

    /* Header */
    header{min-height:55vh;display:flex;align-items:center;justify-content:center;padding:40px 20px;text-align:center;position:relative;z-index:1}
    .welcome-card{background:rgba(255,255,255,.55);padding:28px;border-radius:22px;max-width:900px;box-shadow:0 8px 24px rgba(0,0,0,.1)}
    .enter-btn{background:linear-gradient(90deg,var(--sky),var(--pink));border:none;padding:10px 18px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 8px 14px rgba(0,0,0,.1)}

    main{padding:22px;max-width:1100px;margin:0 auto 140px;position:relative;z-index:1}
    section{background:rgba(255,255,255,.7);padding:18px;border-radius:16px;margin:18px 0;box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}

    /* Widgets */
    .widgets{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
    .widget{background:rgba(255,255,255,.85);padding:12px;border-radius:12px}

    /* Dates */
    .dates-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .date-card{background:rgba(255,255,255,.85);padding:12px;border-radius:12px}
    .date-count{font-size:18px;font-weight:700;margin-top:6px}

    /* Bucket */
    .bucket-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .bucket-item{background:rgba(255,255,255,.9);padding:14px;border-radius:12px;display:flex;gap:10px;align-items:center}
    .bucket-item input[type=checkbox]{width:18px;height:18px}

    /* Gallery (polaroids) */
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .controls input[type="text"], .controls select{padding:8px;border-radius:8px;border:1px solid #ccc}
    .photo-grid{position:relative;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:22px;padding:8px}
    .polaroid{position:relative;width:100%;aspect-ratio:3/4;background:var(--paper);border-radius:8px;padding:10px 10px 36px;box-shadow:0 10px 30px rgba(0,0,0,.18);transform-origin:center;transition:transform .25s ease,box-shadow .25s ease}
    .polaroid:hover{transform:rotate(var(--rot)) translateY(-6px) scale(1.03);box-shadow:0 16px 40px rgba(0,0,0,.24)}
    .polaroid .imgwrap{position:absolute;inset:10px 10px 44px 10px;overflow:hidden;border-radius:6px;background:linear-gradient(135deg,var(--peach),var(--pink))}
    .polaroid img{width:100%;height:100%;object-fit:cover;display:block}
    .caption{position:absolute;left:10px;right:10px;bottom:10px;height:28px;display:flex;align-items:center;justify-content:center;font-family:'Comic Sans MS','Patrick Hand',system-ui;font-size:13px;color:#333}
    .tape{position:absolute;width:46px;height:18px;background:rgba(255,255,200,.8);box-shadow:0 2px 6px rgba(0,0,0,.15);transform:rotate(var(--trot));border-radius:3px}
    .tape:after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(90deg,rgba(255,255,255,.3) 0 6px,rgba(0,0,0,.05) 6px 12px);mix-blend-mode:overlay;border-radius:3px}
    .sticker{position:absolute;font-size:18px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.15))}
    .meta{position:absolute;top:8px;right:10px;font-size:11px;color:#666}
    .actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .sm-btn{background:linear-gradient(90deg,var(--sky),var(--pink));border:none;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 4px 10px rgba(0,0,0,.08)}

    /* Q&A */
    .q-card{margin-bottom:10px}
    .bubble-q{padding:10px 12px;border-radius:14px;display:inline-block;font-weight:600}
    .bubble-a{margin-top:6px;padding:10px;border-radius:12px;font-size:14px;background:rgba(255,255,255,.75)}
    .vishnu-bubble{background:var(--vishnu-pink)}
    .thanya-bubble{background:var(--thanya-blue)}

    /* Music */
    .music-toggle{position:fixed;right:18px;bottom:18px;width:56px;height:56px;background:linear-gradient(90deg,var(--sky),var(--pink));border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 32px rgba(0,0,0,.12);cursor:pointer;z-index:997}

    /* Sparkles + Timeline */
    .sparkles{position:fixed;inset:0;pointer-events:none}
    .spark{position:absolute;width:8px;height:8px;border-radius:50%;opacity:.9}
    .timeline{position:relative;margin-left:8px}
    .timeline::before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--pink),var(--sky))}
    .titem{position:relative;margin:12px 0 12px 32px;background:rgba(255,255,255,.85);padding:10px;border-radius:12px;box-shadow:0 4px 12px #0001}
    .titem::before{content:"";position:absolute;left:-18px;top:14px;width:10px;height:10px;border-radius:50%;background:#ff86b6;box-shadow:0 0 0 3px #fff}

    /* Pets */
    .pet-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-top:16px}
    .pet-card{background:rgba(255,255,255,.9);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);transition:transform .3s ease,box-shadow .3s ease}
    .pet-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .pet-card.priority-high{border-left:4px solid #ff6b6b}
    .pet-card.priority-medium{border-left:4px solid #ffd93d}
    .pet-card.priority-low{border-left:4px solid #6bff6b}
    .pet-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .pet-emoji{font-size:24px}.pet-name{font-size:18px;font-weight:600}
    .pet-notes{color:#666;margin:8px 0}.pet-actions{display:flex;gap:8px;margin-top:12px}

    /* Fancy Love Story Modal */
    #storyModal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:99999}
    #storyCard{max-width:760px;width:clamp(320px,90vw,760px);background:rgba(255,255,255,.96);border-radius:18px;padding:18px 18px 22px;box-shadow:0 18px 44px rgba(0,0,0,.25);position:relative;overflow:hidden}
    #storyTitle{font-weight:800;font-size:18px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    #storyBody{white-space:pre-wrap;line-height:1.5;max-height:60vh;overflow:auto;padding:10px;border-radius:12px;background:rgba(255,255,255,.7);font-size:15px}
    #storyClose{position:absolute;top:10px;right:10px}
    .float-heart{position:absolute;font-size:18px;pointer-events:none;opacity:.9;animation:floatUp 2.4s ease-out forwards}
    @keyframes floatUp{from{transform:translateY(0) scale(1);opacity:.9}to{transform:translateY(-80px) scale(.8);opacity:0}}
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <canvas id="stars"></canvas>

  <!-- Loader -->
  <div id="loader"><div class="heart"></div></div>

  <!-- PASSCODE OVERLAY -->
  <div id="lockScreen">
    <div class="lock-card" id="lockCard">
      <h2>Enter Passcode üíñ</h2>
      <input type="password" id="passInput" maxlength="8" placeholder="Vishnu or Thanya code" />
      <div><button id="unlockBtn">Unlock</button></div>
      <div class="lock-meta">You know the password</div>
    </div>
  </div>

  <!-- Floating Nav -->
  <nav id="floatNav" aria-label="Quick navigation" style="display:none">
    <a href="#widgets" title="Widgets">üå§Ô∏è</a>
    <a href="#dates" title="Dates">üóìÔ∏è</a>
    <a href="#bucket" title="Bucket List">ü™£</a>
    <a href="#gallery" title="Gallery">üì∏</a>
    <a href="#questions" title="Questions">üí¨</a>
    <a href="#notes" title="Notes">üíå</a>
    <a href="#timeline" title="Timeline">üßµ</a>
    <a href="#pets" title="Future Pets">üêæ</a>
  </nav>

  <div class="sparkles" id="sparkles"></div>

  <header>
    <div class="welcome-card">
      <h1>How about we pick a name</h1>
      <p>Welcome to our little digital home üíñüíñ</p>
      <button type="button" class="enter-btn" id="enterBtn">Enter Our World üí´</button>
    </div>
  </header>

  <main id="mainContent" style="display:none">
    <!-- TOP WIDGETS -->
    <section id="widgets">
      <div class="section-title">
        <h2>‚ú® Always-On Love Widgets</h2>
        <div class="controls">
          <button class="sm-btn" id="togglePetals">Blossoms üå∏</button>
          <button class="sm-btn" id="toggleCursorHearts">Cursor Hearts üíó</button>
          <button class="sm-btn" id="toggleStars">Constellations üåå</button>
        </div>
      </div>
      <div class="widgets">
        <div class="widget"><div><strong>Days Together</strong></div><div id="daysTogether" style="font-size:22px;margin-top:6px">...</div></div>
        <div class="widget"><div><strong>Next Anniversary</strong></div><div id="nextAnniv" style="margin-top:6px"></div></div>
        <div class="widget"><div><strong>Birthdays</strong></div><div id="bdays" style="margin-top:6px"></div></div>
        <!-- Mood Reading widget -->
        <div class="widget">
          <div><strong>AI Mood Reading üíû</strong></div>
          <div id="moodLine" style="margin-top:6px;min-height:20px;color:#444">‚Äî</div>
          <div style="font-size:12px;color:#777;margin-top:6px">Auto-refreshes every 30s. First load may take a bit.</div>
        </div>
      </div>
    </section>

    <!-- DATES -->
    <section id="dates">
      <div class="section-title"><h2>‚è≥ Moments We're Waiting For</h2></div>
      <div class="dates-grid" id="datesGrid"></div>
      <div class="controls">
        <input id="evName" placeholder="Event name" />
        <input id="evDate" type="date" />
        <button id="addEvent" class="sm-btn">Add</button>
        <button id="clearEvents" class="sm-btn">Clear</button>
        <button id="resetAnniv" class="sm-btn">Reset to Anniversary</button>
      </div>
    </section>

    <!-- BUCKET LIST -->
    <section id="bucket">
      <div class="section-title"><h2>üåü Our Bucket List</h2></div>
      <div class="controls">
        <input id="newBucket" placeholder="Add new dream..." />
        <button id="addBucket" class="sm-btn">Add</button>
      </div>
      <div class="bucket-list" id="bucketList"></div>
    </section>

    <!-- GALLERY -->
    <section id="gallery">
      <div class="section-title"><h2>üì∏ Scrapbook Polaroids</h2></div>
      <div class="controls">
        <input type="file" id="photoFile" accept="image/*" />
        <input type="text" id="photoCaption" placeholder="Caption (optional)" />
        <select id="photoAuthor">
          <option value="Vishnu">Vishnu</option>
          <option value="Thanya">Thanya</option>
        </select>
        <select id="albumSel"><option value="General">General</option><option>Trips</option><option>Dates</option><option>Food</option><option>Pets</option><option>Silly</option></select>
        <select id="filterSel"><option value="none">No filter</option><option value="vintage">Vintage</option><option value="pastel">Pastel</option><option value="film">Film grain</option><option value="sparkle">Sparkle</option></select>
        <button id="uploadBtn" class="sm-btn">Upload</button>
        <button id="clearPhotosBtn" class="sm-btn">Clear Photos</button>
        <button id="slideshowBtn" class="sm-btn">Slideshow ‚ñ∂Ô∏è</button>
      </div>
      <div class="controls">
        <label>Album view:</label>
        <select id="albumView"><option value="all">All</option><option>General</option><option>Trips</option><option>Dates</option><option>Food</option><option>Pets</option><option>Silly</option></select>
      </div>
      <div class="photo-grid" id="photoGrid"></div>
    </section>

    <!-- Q&A -->
    <section id="questions">
      <div class="section-title"><h2>üí¨ Questions Corner</h2>
        <div class="controls">
          <button id="surpriseBtn" class="sm-btn">Surprise Me üí°</button>
          <button id="aiDeepQBtn" class="sm-btn" title="AI Deep Romantic Question">Deep Question ü§ñüí°</button>
        </div>
      </div>
      <div class="controls">
        <input id="vishnuNew" placeholder="Ask Thanya..." />
        <button id="addVishnu" class="sm-btn">Add</button>
      </div>
      <div id="vishnuQs"></div>

      <div class="controls">
        <input id="thanyaNew" placeholder="Ask Vishnu..." />
        <button id="addThanya" class="sm-btn">Add</button>
      </div>
      <div id="thanyaQs"></div>
    </section>

    <!-- LOVE NOTES -->
    <section id="notes">
      <div class="section-title"><h2>üíå Love Notes</h2>
        <button id="clearAllNotes" class="sm-btn">Clear All</button></div>
      <div class="controls">
        <select id="noteAuthor">
          <option value="Vishnu">Vishnu</option>
          <option value="Thanya">Thanya</option>
        </select>
        <input id="newNoteText" placeholder="Write a sweet note..." />
        <label><input type="checkbox" id="secretNote"/> Secret</label>
        <button id="addNote" class="sm-btn">Add</button>
      </div>
      <div id="notesList"></div>
    </section>

    <!-- TIMELINE & FIRSTS -->
    <section id="timeline">
      <div class="section-title"><h2>üßµ Memory Timeline & Our Firsts</h2></div>
      <!-- Fancy Love Story button under title -->
      <div class="controls">
        <button id="aiStoryBtn" class="sm-btn" title="AI Romantic Story">Generate Love Story üìñ‚ú®</button>
      </div>

      <div class="controls">
        <input id="tlTitle" placeholder="Title (e.g., First trip)" />
        <input id="tlDate" type="date" />
        <input id="tlNote" placeholder="Short memory" />
        <button id="addTL" class="sm-btn">Add to Timeline</button>
      </div>
      <div class="timeline" id="tlList"></div>

      <div class="section-title" style="margin-top:16px"><h3>Our Firsts</h3></div>
      <div class="controls">
        <input id="fKey" placeholder="First (e.g., first text)" />
        <input id="fDate" type="date" />
        <input id="fDesc" placeholder="Describe it" />
        <button id="addFirst" class="sm-btn">Save</button>
      </div>
      <div id="firsts"></div>

      <div class="section-title" style="margin-top:16px"><h3>üèÖ Milestones</h3></div>
      <div id="milestones"></div>
    </section>

    <!-- FUTURE PETS -->
    <section id="pets">
      <div class="section-title">
        <h2>üêæ Future Pet Dreams</h2>
        <div class="controls"></div>
      </div>
      <div class="controls">
        <input id="petName" placeholder="Pet name" />
        <select id="petType">
          <optgroup label="Common Pets">
            <option value="üê±">Cat</option><option value="üêà‚Äç‚¨õ">Black Cat</option><option value="üò∫">Friendly Cat</option>
            <option value="üêï">Dog</option><option value="ü¶Æ">Guide Dog</option><option value="üêï‚Äçü¶∫">Service Dog</option>
            <option value="üê¶">Bird</option><option value="ü¶ú">Parrot</option><option value="ü¶ö">Peacock</option>
            <option value="üê∞">Rabbit</option><option value="üêπ">Hamster</option><option value="üê≠">Mouse</option>
            <option value="üê¢">Turtle</option>
          </optgroup>
          <optgroup label="Big Cats">
            <option value="üêØ">Tiger</option><option value="ü¶Å">Lion</option><option value="üêÜ">Leopard</option>
            <option value="‚ùÑÔ∏èüêÜ">Snow Leopard</option><option value="‚ö°üêÜ">Cheetah</option><option value="üêÜ‚ú®">Black Panther</option><option value="üêØ‚ö™">White Tiger</option>
          </optgroup>
          <optgroup label="Sharks">
            <option value="ü¶à">Great White Shark</option><option value="ü¶à‚ö°">Tiger Shark</option><option value="ü¶àüêÜ">Leopard Shark</option>
            <option value="ü¶àüí´">Epaulette Shark</option><option value="ü¶àüçã">Lemon Shark</option><option value="ü¶àüî®">Hammerhead Shark</option>
            <option value="ü¶àüåä">Reef Shark</option><option value="ü¶à‚öîÔ∏è">Thresher Shark</option><option value="ü¶àüëª">Ghost Shark</option><option value="ü¶à‚ùÑÔ∏è">Greenland Shark</option>
          </optgroup>
          <optgroup label="Marine Life">
            <option value="üêã">Blue Whale</option><option value="‚ö°üê¨">Orca (Killer Whale)</option><option value="üê≥">Sperm Whale</option>
            <option value="üê¨">Dolphin</option><option value="üê†">Tropical Fish</option><option value="üê°">Pufferfish</option><option value="üêü">Fish</option><option value="ü¶≠">Seal</option><option value="ü¶¶">Otter</option><option value="üêã‚ú®">Narwhal</option><option value="ü¶ë">Giant Squid</option>
          </optgroup>
          <optgroup label="Exotic Pets">
            <option value="ü¶é">Lizard</option><option value="üêä">Alligator</option><option value="üêç">Snake</option>
            <option value="ü¶ñ">T-Rex</option><option value="ü¶ï">Sauropod</option><option value="ü¶ò">Kangaroo</option><option value="ü¶ô">Llama</option><option value="ü¶í">Giraffe</option><option value="ü¶õ">Hippopotamus</option>
          </optgroup>
          <optgroup label="Rare & Wild Animals">
            <option value="üêº">Panda</option><option value="üêò">Elephant</option><option value="ü¶è">Rhinoceros</option><option value="ü¶¨">Bison</option><option value="ü¶£">Mammoth</option><option value="ü¶Ö">Eagle</option><option value="ü¶©">Flamingo</option><option value="ü¶ä">Fox</option><option value="üê∫">Wolf</option>
          </optgroup>
          <optgroup label="Mythical Creatures">
            <option value="ü¶Ñ">Unicorn</option><option value="üêâ">Dragon</option><option value="ü¶Æ‚ÄçüëÅ">Three-Headed Dog</option><option value="ü¶Ö‚ú®">Phoenix</option><option value="üêâ‚ùÑÔ∏è">Ice Dragon</option><option value="ü¶àüëë">Megalodon</option>
          </optgroup>
          <optgroup label="Other">
            <option value="üêæ">Custom Pet (Other)</option><option value="‚ú®">Magical Creature</option><option value="üåü">Mystery Pet</option>
          </optgroup>
        </select>
        <input id="petNotes" placeholder="Notes (breed, color, etc)" />
        <select id="petPriority">
          <option value="high">High Priority</option>
          <option value="medium">Medium Priority</option>
          <option value="low">Low Priority</option>
        </select>
        <button id="addPet" class="sm-btn">Add Pet</button>
      </div>
      <div id="petsList" class="pet-grid"></div>
    </section>
  </main>

  <div class="music-toggle" id="musicToggle" title="Play / Pause music">üéµ</div>
  <footer>Made with üíñ for Thanya</footer>

  <!-- Fancy Love Story Modal -->
  <div id="storyModal">
    <div id="storyCard">
      <button id="storyClose" class="sm-btn">Close</button>
      <div id="storyTitle">üìñ AI Love Story</div>
      <div id="storyBody">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    // ====== Constants & couple data ======
    const COUPLE = {
      startDate:'2025-06-12', annivMonth:6, annivDay:13,
      vishnuPass:'246810', thanyaPass:'135790',
      vishnuBirthday:'2007-05-18', thanyaBirthday:'2007-04-05'
    };
    const PASS_TRIES_MAX = 5;

    // ====== Utilities ======
    const $ = id => document.getElementById(id);
    const toHTML = (t='') => t.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    function hideLoader(){ const ld=$('loader'); if(!ld) return; ld.classList.add('fade-out'); ld.addEventListener('animationend', ()=> ld.remove()); }
    setTimeout(hideLoader,900);
    function burstSparkles(xPct,yPct){ const c=$('sparkles'); for(let i=0;i<16;i++){ const s=document.createElement('div'); s.className='spark'; s.style.left=(xPct+(Math.random()*8-4))+'%'; s.style.top=(yPct+(Math.random()*6-3))+'%'; s.style.background=['#FFD1BF','#FFC0D6','#BFE9FF','#FFF7EE'][Math.floor(Math.random()*4)]; c.appendChild(s); const dur=900+Math.random()*700; s.animate([{transform:'translateY(0) scale(1)',opacity:1},{transform:'translateY(-60px) scale(.6)',opacity:0}],{duration:dur,easing:'cubic-bezier(.2,.7,.2,1)'}); setTimeout(()=>s.remove(),dur+60);} }

    // ====== Stars ======
    let starsCanvas, sctx, starsOn=false, starPts=[], animationFrame;
    function initStars(){ starsCanvas=$('stars'); if(!starsCanvas) return; sctx=starsCanvas.getContext('2d',{alpha:true}); resizeStars(); starPts=Array.from({length:80},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3})); }
    function resizeStars(){ if(!starsCanvas) return; starsCanvas.width=innerWidth; starsCanvas.height=innerHeight; }
    function drawStars(){ if(!starsOn||!sctx) return; sctx.clearRect(0,0,starsCanvas.width,starsCanvas.height); starPts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>starsCanvas.width) p.vx*=-1; if(p.y<0||p.y>starsCanvas.height) p.vy*=-1; sctx.fillStyle='rgba(255,255,255,.9)'; sctx.beginPath(); sctx.arc(p.x,p.y,1.2,0,6.28); sctx.fill(); }); for(let i=0;i<starPts.length;i++){ for(let j=i+1;j<starPts.length;j++){ const a=starPts[i], b=starPts[j]; const d=Math.hypot(a.x-b.x,a.y-b.y); if(d<110){ sctx.strokeStyle='rgba(255,255,255,'+(1-d/110)+')'; sctx.lineWidth=.6; sctx.beginPath(); sctx.moveTo(a.x,a.y); sctx.lineTo(b.x,b.y); sctx.stroke(); } } } requestAnimationFrame(drawStars); }
    function toggleStars(){ if(!sctx){ initStars(); } starsOn=!starsOn; if(starsOn){ resizeStars(); drawStars(); } else { sctx.clearRect(0,0,starsCanvas.width,starsCanvas.height); } }
    addEventListener('resize', resizeStars);

    // ====== Blossoms & Cursor hearts ======
    let petalsOn=false, petalTimer=null;
    function spawnPetal(){ const p=document.createElement('div'); p.className='petal'; p.textContent='üå∏'; p.style.left=Math.random()*100+'%'; p.style.top='-40px'; const dur=6000+Math.random()*5000; const drift=(Math.random()*60-30)+'px'; p.animate([{transform:'translate(0,0)'},{transform:`translate(${drift}, ${innerHeight+80}px)`}],{duration:dur,easing:'linear'}); document.body.appendChild(p); setTimeout(()=>p.remove(),dur+100); }
    function togglePetals(){ petalsOn=!petalsOn; if(petalsOn){ petalTimer=setInterval(spawnPetal,600); } else { clearInterval(petalTimer); petalTimer=null; document.querySelectorAll('.petal').forEach(n=>n.remove()); } }
    let cursorOn=false; function toggleCursor(){ cursorOn=!cursorOn; if(cursorOn){ addEventListener('pointermove',heartTrail); } else { removeEventListener('pointermove',heartTrail); document.querySelectorAll('.cursor-heart').forEach(n=>n.remove()); } }
    function heartTrail(e){ const h=document.createElement('div'); h.className='cursor-heart'; h.textContent=['üíó','üíû','üíñ','üíò'][Math.floor(Math.random()*4)]; h.style.left=(e.clientX-8)+'px'; h.style.top=(e.clientY-8)+'px'; const dur=800+Math.random()*400; h.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(-20px) scale(.7)',opacity:0}],{duration:dur}); document.body.appendChild(h); setTimeout(()=>h.remove(),dur+40); }

    // ====== Firebase config ======
    const firebaseConfig = {
      apiKey:"AIzaSyAH-tY0cqZ38nzTl9Z5VBeLU739v8O3XCA",
      authDomain:"our-digital-home.firebaseapp.com",
      databaseURL:"https://our-digital-home-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"our-digital-home", storageBucket:"our-digital-home.appspot.com",
      messagingSenderId:"381695438861", appId:"1:381695438861:web:5759fcbb1bb5cbb152e544"
    };
    const PATH = {
      events:'events', bucketItems:'bucket/items', bucketState:'bucket/state',
      qVishnu:'questions/vishnu', qThanya:'questions/thanya',
      notes:'notes', timeline:'timeline', firsts:'firsts', gallery:'gallery/items', pets:'pets/list'
    };

    function ensureFirebaseReady(cb){
      if(window.firebase && typeof firebase.initializeApp==='function'){ cb(); return; }
      const started=Date.now(); const t=setInterval(()=>{ if(window.firebase && typeof firebase.initializeApp==='function'){ clearInterval(t); cb(); } else if(Date.now()-started>6000){ clearInterval(t); alert('Firebase failed to load. Refresh.'); }},120);
    }

    // ====== Lock & music ======
    let passTries=0,CURRENT_USER='';
    $('unlockBtn').addEventListener('click',()=>{
      const val=$('passInput').value.trim(); const card=$('lockCard');
      const ok=(val===COUPLE.vishnuPass)||(val===COUPLE.thanyaPass);
      if(ok){ CURRENT_USER=(val===COUPLE.vishnuPass)?'Vishnu':'Thanya'; $('lockScreen').style.display='none'; $('floatNav').style.display='flex'; ensureFirebaseReady(initFirebaseAndApp); }
      else{ passTries++; card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake'); if(passTries>=PASS_TRIES_MAX){ $('unlockBtn').disabled=true; $('passInput').disabled=true; }}
    });
    let audioCtx=null, masterGain=null, osc1=null, playing=false;
    function startMusic(){ if(playing) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.06; masterGain.connect(audioCtx.destination); osc1=audioCtx.createOscillator(); osc1.type='sine'; osc1.frequency.value=196; const osc2=audioCtx.createOscillator(); osc2.type='triangle'; osc2.frequency.value=261.6; const g2=audioCtx.createGain(); g2.gain.value=0.1; osc1.connect(masterGain); osc2.connect(g2); g2.connect(masterGain); osc1.start(); osc2.start(); playing=true; }
    function stopMusic(){ if(!playing) return; try{osc1.stop()}catch(e){} try{audioCtx.close()}catch(e){} audioCtx=null; masterGain=null; osc1=null; playing=false; }
    $('musicToggle').addEventListener('click',()=>{ if(!playing){ startMusic(); $('musicToggle').textContent='‚è∏'; } else { stopMusic(); $('musicToggle').textContent='üéµ'; } });
    $('togglePetals').onclick=togglePetals; $('toggleCursorHearts').onclick=toggleCursor; $('toggleStars').onclick=toggleStars;
    $('enterBtn').addEventListener('click',()=>{ const main=$('mainContent'); main.style.display='block'; const top=main.offsetTop; scrollTo({top,behavior:'smooth'}); });

    // ====== App init ======
    function initFirebaseAndApp(){
      try{ if(!firebase.apps||!firebase.apps.length){ firebase.initializeApp(firebaseConfig); } }catch(e){ if(!/already exists/i.test(String(e))) throw e; }
      const auth=firebase.auth(); const db=firebase.database(); let UID=null;

      auth.signInAnonymously().then(res=>{
        UID=res.user.uid;
        const sel=$('noteAuthor'); sel.value=(CURRENT_USER==='Thanya')?'Thanya':'Vishnu';
        startRealtime();
      }).catch(err=>{ console.error('Auth failed',err); startRealtime(); });

      function countdownTo(dateStr){ const now=new Date(); const t=new Date(dateStr+'T00:00:00'); const d=t-now; if(d<=0) return 'Today!'; const days=Math.floor(d/86400000); const hrs=Math.floor((d%86400000)/3600000); const mins=Math.floor((d%3600000)/60000); return `${days}d ${hrs}h ${mins}m`; }
      function nextAnniversary(){ const now=new Date(); let y=now.getFullYear(); let t=new Date(y,COUPLE.annivMonth-1,COUPLE.annivDay); if(t<now) t=new Date(y+1,COUPLE.annivMonth-1,COUPLE.annivDay); return t.toISOString().slice(0,10); }
      function daysTogether(){ const a=new Date(COUPLE.startDate+'T00:00:00'); const b=new Date(); return Math.floor((b-a)/86400000); }
      function renderWidgets(){ $('daysTogether').textContent=daysTogether()+' days'; const ann=nextAnniversary(); $('nextAnniv').textContent=ann+' ‚Ä¢ '+countdownTo(ann); const vb=new Date(COUPLE.vishnuBirthday).toISOString().slice(5,10); const tb=new Date(COUPLE.thanyaBirthday).toISOString().slice(5,10); $('bdays').textContent=`Vishnu: ${vb} ‚Ä¢ Thanya: ${tb}`; }
      renderWidgets();

      // ====== Realtime sections ======
      function startRealtime(){
        // DATES
        const evRef=db.ref(PATH.events);
        function startCountdown(el,iso){ function up(){ const now=new Date(); const t=new Date(iso+'T00:00:00'); const d=t-now; if(d<=0){ el.textContent='Happening now or passed!'; return; } const days=Math.floor(d/86400000); const hrs=Math.floor((d%86400000)/3600000); const mins=Math.floor((d%3600000)/60000); const secs=Math.floor((d%60000)/1000); el.textContent=`${days}d ${hrs}h ${mins}m ${secs}s`; } up(); return setInterval(up,1000);}
        function renderEventsUI(map){ const grid=$('datesGrid'); grid.innerHTML=''; const arr=Object.entries(map||{}).map(([id,e])=>({id,...e})).sort((a,b)=>(a.date||'').localeCompare(b.date||'')); arr.forEach(e=>{ const card=document.createElement('div'); card.className='date-card'; card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${toHTML(e.name||'Untitled')}</strong><div class="date-meta" style="font-size:13px;color:#666">${e.date||''}</div></div><button class="sm-btn" data-id="${e.id}" data-act="rm">‚ùå</button></div><div class="date-count" id="count_${e.id}">...</div>`; grid.appendChild(card); const el=$('count_'+e.id); if(el&&e.date) startCountdown(el,e.date); }); }
        $('addEvent').addEventListener('click',()=>{ const name=$('evName').value.trim(); const date=$('evDate').value; if(!name||!date) return alert('Please add both name and date'); const id=evRef.push().key; evRef.child(id).set({id,name,date,createdAt:Date.now()}); $('evName').value=''; $('evDate').value=''; });
        $('clearEvents').addEventListener('click',()=>{ if(confirm('Clear ALL events?')) evRef.set(null); });
        $('resetAnniv').addEventListener('click',()=>{ if(!confirm('Reset to Anniversary only?')) return; const id=evRef.push().key; evRef.set({[id]:{id,name:'Our Anniversary üíû',date:`${new Date().getFullYear()}-${String(COUPLE.annivMonth).padStart(2,'0')}-${String(COUPLE.annivDay).padStart(2,'0')}`,createdAt:Date.now()}}); });
        $('datesGrid').addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-act="rm"]'); if(!btn) return; const id=btn.dataset.id; evRef.child(id).remove(); });
        evRef.on('value',snap=> renderEventsUI(snap.val()||{}));

        // BUCKET
        function renderBucketUI(itemsMap,stateMap){ const c=$('bucketList'); c.innerHTML=''; const arr=Object.entries(itemsMap||{}).map(([id,it])=>({id,...it})); arr.forEach(it=>{ const div=document.createElement('div'); div.className='bucket-item'; const checked=!!(stateMap&&stateMap[it.id]); div.innerHTML=`<div style="font-size:22px">${it.emoji||'‚ú®'}</div><label style="display:flex;align-items:center;gap:10px;flex:1"><input type="checkbox" data-id="${it.id}" ${checked?'checked':''}><div><strong>${toHTML(it.text||'')}</strong><div style="font-size:12px;color:#666">Click to mark done</div></div></label>`; c.appendChild(div); }); c.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.addEventListener('change',e=>{ const id=e.target.dataset.id; const checked=e.target.checked; db.ref(PATH.bucketState).update({[id]:checked}); if(checked) burstSparkles(50,40); }); }); }
        $('addBucket').addEventListener('click',()=>{ const inp=$('newBucket'); const val=inp.value.trim(); if(!val) return; const id=db.ref(PATH.bucketItems).push().key; db.ref(`${PATH.bucketItems}/${id}`).set({id,emoji:'‚ú®',text:val,createdAt:Date.now()}); inp.value=''; });
        db.ref(PATH.bucketItems).on('value',snap=>{ const items=snap.val(); if(!items){ [{emoji:'üê†',text:'Aquarium date'},{emoji:'üç≥',text:'Make food together'},{emoji:'üè∫',text:'Pottery date'},{emoji:'üêà',text:'Get a Bengal cat'}].forEach(d=>{ const id=db.ref(PATH.bucketItems).push().key; db.ref(`${PATH.bucketItems}/${id}`).set({id,...d,createdAt:Date.now()}); }); } });
        db.ref(PATH.bucketItems).on('value',itemsSnap=>{ const items=itemsSnap.val()||{}; db.ref(PATH.bucketState).on('value',stateSnap=>{ renderBucketUI(items,stateSnap.val()||{}); }); });

        // GALLERY
        function randomBetween(a,b){ return a + Math.random()*(b-a); }
        function polaroidNode(item){ const wrap=document.createElement('div'); wrap.className='polaroid'; const rot=(randomBetween(-6,6).toFixed(2)+'deg'); wrap.style.setProperty('--rot',rot);
          [{x:14,y:-8,r:-8},{x:60,y:-10,r:8},{x:40,y:-10,r:2}].forEach(t=>{ const tp=document.createElement('div'); tp.className='tape'; tp.style.left=t.x+'px'; tp.style.top=t.y+'px'; tp.style.setProperty('--trot', t.r+'deg'); wrap.appendChild(tp); }); const stickers=['‚ú®','üíò','‚≠ê','üíñ','üå∏','ü©∑','üí´']; const sk=document.createElement('div'); sk.className='sticker'; sk.textContent=stickers[Math.floor(Math.random()*stickers.length)]; sk.style.left=randomBetween(8,70)+'%'; sk.style.top=randomBetween(6,20)+'%'; wrap.appendChild(sk); const imgw=document.createElement('div'); imgw.className='imgwrap'; const img=new Image(); img.src=item.data; img.alt=item.caption||'Our photo'; if(item.filter==='vintage') img.style.filter='sepia(.35) contrast(1.05)'; if(item.filter==='pastel') img.style.filter='saturate(1.2) brightness(1.05)'; if(item.filter==='film') img.style.filter='contrast(1.15) grayscale(.1)'; if(item.filter==='sparkle'){ img.style.filter='brightness(1.08)'; }
          imgw.appendChild(img); wrap.appendChild(imgw); const cap=document.createElement('div'); cap.className='caption'; cap.textContent=(item.album?`[${item.album}] `:'')+(item.caption||''); wrap.appendChild(cap); const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${item.author||''} ‚Ä¢ ${new Date(item.time||Date.now()).toLocaleDateString()}`; wrap.appendChild(meta); if(item.uid===UID){ const actions=document.createElement('div'); actions.className='actions'; const del=document.createElement('button'); del.className='sm-btn'; del.textContent='Delete'; del.addEventListener('click',()=>{ if(confirm('Delete this photo?')) db.ref(`${PATH.gallery}/${item.id}`).remove(); }); actions.appendChild(del); wrap.appendChild(actions);} wrap.style.opacity='0'; wrap.style.transform=`rotate(${rot}) scale(.98)`; requestAnimationFrame(()=>{ wrap.style.transition='transform .35s ease, opacity .35s ease, box-shadow .35s ease'; wrap.style.opacity='1'; wrap.style.transform=`rotate(${rot}) scale(1)`; }); return wrap; }
        function handleUpload(){ const file=$('photoFile').files[0]; if(!file) return alert('Pick a photo'); const caption=$('photoCaption').value.trim(); const author=$('photoAuthor').value||'Vishnu'; const album=$('albumSel').value||'General'; const filter=$('filterSel').value||'none'; const reader=new FileReader(); reader.onload=()=>{ const base64=reader.result; const id=db.ref(PATH.gallery).push().key; db.ref(`${PATH.gallery}/${id}`).set({id,data:base64,caption,author,album,filter,uid:UID,time:Date.now()}); $('photoFile').value=''; $('photoCaption').value=''; }; reader.readAsDataURL(file); }
        $('uploadBtn').addEventListener('click', handleUpload);
        let galleryCache=[]; function renderGallery(){ const grid=$('photoGrid'); grid.innerHTML=''; const sel=$('albumView').value; const items=galleryCache.filter(it=> sel==='all' || (it.album||'General')===sel); items.forEach(it=> grid.appendChild(polaroidNode(it))); updateMilestones(); }
        db.ref(PATH.gallery).on('value',snap=>{ galleryCache=Object.entries(snap.val()||{}).map(([id,it])=>({id,...it})).sort((a,b)=>(b.time||0)-(a.time||0)); renderGallery(); });
        $('albumView').addEventListener('change', renderGallery);
        $('clearPhotosBtn').addEventListener('click',()=>{ if(confirm('Delete ALL photos?')) db.ref(PATH.gallery).set(null); });
        $('slideshowBtn').addEventListener('click',()=>{ if(galleryCache.length===0) return alert('No photos yet!'); let i=0; const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='rgba(0,0,0,.8)'; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex='9998'; const img=new Image(); img.style.maxWidth='90%'; img.style.maxHeight='85%'; overlay.appendChild(img); document.body.appendChild(overlay); function show(){ img.src=galleryCache[i].data; } show(); const timer=setInterval(()=>{ i=(i+1)%galleryCache.length; show(); },2500); overlay.addEventListener('click',()=>{ clearInterval(timer); overlay.remove(); }); });

        // QUESTIONS
        const surprisePrompts=['What‚Äôs a tiny thing I did recently that made you smile?','Describe our dream weekend together in one paragraph.','If our love was a movie genre, what would it be and why?','What song instantly reminds you of us?','What‚Äôs a new tradition you want us to start?'];
        $('surpriseBtn').addEventListener('click',()=>{ const p=surprisePrompts[Math.floor(Math.random()*surprisePrompts.length)]; const id=db.ref(PATH.qVishnu).push().key; db.ref(`${PATH.qVishnu}/${id}`).set({id,q:p,a:'',liked:false,createdAt:Date.now()}); });
        function renderQsList(key,containerId){ db.ref(key).on('value',snap=>{ const c=$(containerId); c.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,q])=>({id,...q})).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); arr.forEach(obj=>{ const wrap=document.createElement('div'); wrap.className='q-card'; const isV=(key===PATH.qVishnu); const qB=document.createElement('div'); qB.className='bubble-q '+(isV?'vishnu-bubble':'thanya-bubble'); qB.textContent=obj.q; const aB=document.createElement('div'); aB.className='bubble-a'; aB.textContent=obj.a||''; const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px'; const ansBtn=document.createElement('button'); ansBtn.textContent=obj.a?'Edit Answer':'Answer'; ansBtn.className='sm-btn'; const del=document.createElement('button'); del.textContent='Delete'; del.className='sm-btn'; const like=document.createElement('button'); like.textContent=obj.liked?'‚ù§Ô∏è':'ü§ç'; like.className='sm-btn'; ansBtn.addEventListener('click',()=>{ const ta=document.createElement('textarea'); ta.style.width='100%'; ta.style.minHeight='60px'; ta.value=obj.a||''; const saveBtn=document.createElement('button'); saveBtn.textContent='Save'; saveBtn.className='sm-btn'; saveBtn.style.marginTop='6px'; aB.innerHTML=''; aB.appendChild(ta); aB.appendChild(saveBtn); saveBtn.addEventListener('click',()=>{ db.ref(`${key}/${obj.id}`).update({a:ta.value}); }); }); del.addEventListener('click',()=> db.ref(`${key}/${obj.id}`).remove()); like.addEventListener('click',()=> db.ref(`${key}/${obj.id}`).update({liked: !obj.liked})); row.appendChild(ansBtn); row.appendChild(like); row.appendChild(del); wrap.appendChild(qB); wrap.appendChild(aB); wrap.appendChild(row); c.appendChild(wrap); }); }); }
        $('addVishnu').addEventListener('click',()=>{ const val=$('vishnuNew').value.trim(); if(!val) return; const id=db.ref(PATH.qVishnu).push().key; db.ref(`${PATH.qVishnu}/${id}`).set({id,q:val,a:'',liked:false,createdAt:Date.now()}); $('vishnuNew').value=''; });
        $('addThanya').addEventListener('click',()=>{ const val=$('thanyaNew').value.trim(); if(!val) return; const id=db.ref(PATH.qThanya).push().key; db.ref(`${PATH.qThanya}/${id}`).set({id,q:val,a:'',liked:false,createdAt:Date.now()}); $('thanyaNew').value=''; });
        renderQsList(PATH.qVishnu,'vishnuQs'); renderQsList(PATH.qThanya,'thanyaQs');

        // LOVE NOTES
        function renderNotes(){ db.ref(PATH.notes).on('value',snap=>{ const list=$('notesList'); list.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,n])=>({id,...n})); arr.sort((a,b)=> (b.pinned===true?1:0)-(a.pinned===true?1:0) || (b.createdAt||0)-(a.createdAt||0)); arr.forEach(n=>{ const card=document.createElement('div'); const bg=n.author==='Vishnu'?'rgba(255,209,230,.9)':'rgba(207,239,255,.9)'; Object.assign(card.style,{background:bg,padding:'12px',borderRadius:'16px',marginBottom:'10px',boxShadow:'0 4px 12px rgba(0,0,0,.08)',position:'relative',transition:'0.3s ease'}); const safeText=toHTML(n.text||''); const body=document.createElement('div'); body.style.margin='4px 0 8px'; body.style.whiteSpace='pre-wrap'; body.innerHTML=safeText; if(n.secret){ body.style.filter='blur(6px)'; body.style.cursor='pointer'; body.title='Tap to reveal'; body.addEventListener('click',()=>{ body.style.filter='none'; }); }
          card.innerHTML=`<div style="display:flex; align-items:center; gap:8px; margin-bottom:6px"><div style="font-size:20px">${n.author==='Vishnu'?'ü©∑':'üíô'}</div><strong>${n.author||''}</strong><span style="font-size:12px; color:#555">‚Ä¢ ${new Date(n.createdAt||Date.now()).toLocaleString()}</span></div>`; card.appendChild(body);
          const actions=document.createElement('div'); actions.className='note-actions'; actions.style.display='flex'; actions.style.gap='8px'; const pin=document.createElement('button'); pin.className='sm-btn'; pin.textContent=n.pinned?'üìå Pinned':'üìç Pin'; pin.onclick=()=>db.ref(`${PATH.notes}/${n.id}`).update({pinned:!n.pinned}); const like=document.createElement('button'); like.className='sm-btn'; like.textContent=n.liked?'‚ù§Ô∏è':'ü§ç'; like.onclick=()=>db.ref(`${PATH.notes}/${n.id}`).update({liked:!n.liked}); const del=document.createElement('button'); del.className='sm-btn'; del.textContent='Delete'; del.onclick=()=>db.ref(`${PATH.notes}/${n.id}`).remove(); actions.append(pin,like,del); card.appendChild(actions); card.style.opacity=0; card.style.transform='translateY(10px)'; $('notesList').appendChild(card); requestAnimationFrame(()=>{ card.style.transition='0.4s ease'; card.style.opacity=1; card.style.transform='translateY(0)'; }); }); }); }
        $('addNote').addEventListener('click',()=>{ const author=$('noteAuthor').value; const text=$('newNoteText').value.trim(); const secret=$('secretNote').checked; if(!text) return; const id=db.ref(PATH.notes).push().key; db.ref(`${PATH.notes}/${id}`).set({id,author,text,secret,liked:false,pinned:false,createdAt:Date.now()}); $('newNoteText').value=''; $('secretNote').checked=false; });
        renderNotes();
        $('clearAllNotes').addEventListener('click',()=>{ if(confirm('Are you absolutely sure you want to delete ALL love notes?')){ if(confirm('This cannot be undone. Delete EVERYTHING?')){ db.ref(PATH.notes).set(null); } } });

        // TIMELINE
        function renderTL(){ db.ref(PATH.timeline).on('value',snap=>{ const c=$('tlList'); c.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,t])=>({id,...t})).sort((a,b)=>(a.date||'').localeCompare(b.date||'')); arr.forEach(t=>{ const it=document.createElement('div'); it.className='titem'; it.innerHTML=`<strong>${toHTML(t.title||'')}</strong><div style="font-size:12px;color:#666">${t.date||''}</div><div style="margin-top:6px">${toHTML(t.note||'')}</div>`; c.appendChild(it); }); }); }
        $('addTL').addEventListener('click',()=>{ const title=$('tlTitle').value.trim(); const date=$('tlDate').value; const note=$('tlNote').value.trim(); if(!title||!date) return; const id=db.ref(PATH.timeline).push().key; db.ref(`${PATH.timeline}/${id}`).set({id,title,date,note,createdAt:Date.now()}); $('tlTitle').value=''; $('tlDate').value=''; $('tlNote').value=''; });
        renderTL();

        function renderFirsts(){ db.ref(PATH.firsts).on('value',snap=>{ const c=$('firsts'); c.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,f])=>({id,...f})); arr.forEach(f=>{ const d=document.createElement('div'); d.className='titem'; d.innerHTML=`<strong>${toHTML(f.key||'')}</strong> ‚Äî <span style="font-size:12px;color:#666">${f.date||''}</span><div style="margin-top:6px">${toHTML(f.desc||'')}</div>`; c.appendChild(d); }); }); }
        $('addFirst').addEventListener('click',()=>{ const key=$('fKey').value.trim(); const date=$('fDate').value; const desc=$('fDesc').value.trim(); if(!key||!date) return; const id=db.ref(PATH.firsts).push().key; db.ref(`${PATH.firsts}/${id}`).set({id,key,date,desc,createdAt:Date.now()}); $('fKey').value=''; $('fDate').value=''; $('fDesc').value=''; });
        renderFirsts();

        // PETS
        function renderPets(){ db.ref(PATH.pets).on('value',snap=>{ const container=$('petsList'); container.innerHTML=''; const pets=Object.entries(snap.val()||{}).map(([id,pet])=>({id,...pet})).sort((a,b)=>({high:0,medium:1,low:2})[a.priority||'low']-({high:0,medium:1,low:2})[b.priority||'low']); pets.forEach(pet=>{ const card=document.createElement('div'); card.className=`pet-card priority-${pet.priority||'low'}`; const header=document.createElement('div'); header.className='pet-header'; header.innerHTML=`<div class="pet-emoji">${pet.type||'üêæ'}</div><div class="pet-name">${toHTML(pet.name||'Unnamed pet')}</div>`; const notes=document.createElement('div'); notes.className='pet-notes'; notes.textContent=pet.notes||''; const actions=document.createElement('div'); actions.className='pet-actions'; const del=document.createElement('button'); del.className='sm-btn'; del.textContent='Delete'; del.onclick=()=>{ if(confirm('Delete this pet from the list?')) db.ref(`${PATH.pets}/${pet.id}`).remove(); }; const tog=document.createElement('button'); tog.className='sm-btn'; tog.textContent='‚≠ê Priority'; tog.onclick=()=>{ const seq=['high','medium','low']; const nxt=seq[(seq.indexOf(pet.priority||'low')+1)%seq.length]; db.ref(`${PATH.pets}/${pet.id}`).update({priority:nxt}); }; actions.append(tog,del); card.append(header,notes,actions); card.style.opacity='0'; card.style.transform='translateY(20px)'; container.appendChild(card); requestAnimationFrame(()=>{ card.style.transition='opacity .3s ease, transform .3s ease'; card.style.opacity='1'; card.style.transform='translateY(0)'; }); }); }); }
        $('addPet').addEventListener('click',()=>{ const name=$('petName').value.trim(); const type=$('petType').value; const notes=$('petNotes').value.trim(); const priority=$('petPriority').value; if(!name) return alert('Please enter a pet name!'); const id=db.ref(PATH.pets).push().key; db.ref(`${PATH.pets}/${id}`).set({id,name,type,notes,priority,createdAt:Date.now()}); $('petName').value=''; $('petNotes').value=''; burstSparkles(50,70); });
        renderPets();

        // Milestones
        function updateMilestones(){ const c=$('milestones'); const photos=galleryCache.length; db.ref(PATH.notes).once('value').then(s=>{ const notes=s.val()? Object.keys(s.val()).length : 0; const badges=[]; if(photos>=20) badges.push('üì∏ 20 photos!'); if(photos>=50) badges.push('üèÜ 50 photos milestone'); if(notes>=50) badges.push('üíå 50 love notes!'); if(daysTogether()>=365) badges.push('üéâ 1 year together!'); c.textContent=badges.length?badges.join(' ‚Ä¢ '):'No milestones yet ‚Äî keep making memories!'; }); }

        // Show main
        $('floatNav').style.display='flex'; $('mainContent').style.display='block';
      } // startRealtime

      // ====== WebLLM (local AI) ======
      // Load UMD bundle
      let webllmEngine=null;
      function loadWebLLM(){ return new Promise((resolve,reject)=>{ if(window.webllm) return resolve(window.webllm); const s=document.createElement('script'); s.src="https://unpkg.com/@mlc-ai/web-llm/dist/index.min.js"; s.onload=()=>resolve(window.webllm); s.onerror=()=>reject(new Error('WebLLM failed to load')); document.head.appendChild(s); }); }
      async function ensureLLM(){
        if(webllmEngine) return webllmEngine;
        const webllm=await loadWebLLM();
        const candidates=[
          "Llama-3.2-3B-Instruct-q4f32_1-MLC", // ‚úÖ your pick (balanced)
          "TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC",
          "Qwen2.5-0.5B-Instruct-q4f32_1-MLC"
        ];
        let lastErr=null;
        for(const model_id of candidates){
          try{
            webllmEngine=await webllm.CreateMLCEngine({model_id});
            console.log("[WebLLM] ready:",model_id);
            return webllmEngine;
          }catch(e){ console.warn("[WebLLM] model failed:",model_id,e); lastErr=e; }
        }
        throw lastErr||new Error("No local model available");
      }
      async function aiChat(prompt){
        const engine=await ensureLLM();
        if(engine?.chat?.completions?.create){
          const out=await engine.chat.completions.create({
            messages:[
              {role:"system",content:"You are a sweet, playful romantic assistant for a couple named Vishnu and Thanya. Keep outputs short, wholesome, and cute."},
              {role:"user",content:prompt}
            ],
            max_tokens:220, temperature:0.9
          });
          return (out?.choices?.[0]?.message?.content||"").trim();
        }
        if(engine?.generate){
          return (await engine.generate(prompt,{max_tokens:220,temperature:0.9})).trim();
        }
        throw new Error("Unsupported WebLLM interface");
      }

      // === AI #1: Deep Question (simple, saves to Vishnu Qs) ===
      const deepBtn=$('aiDeepQBtn');
      if(deepBtn) deepBtn.addEventListener('click', async ()=>{
        deepBtn.disabled=true; const orig=deepBtn.textContent; deepBtn.textContent='Thinking‚Ä¶';
        try{
          const q=await aiChat("Generate exactly ONE deep, meaningful, romantic question for a couple (Vishnu and Thanya). Keep it one sentence.");
          const id=firebase.database().ref(PATH.qVishnu).push().key;
          await firebase.database().ref(`${PATH.qVishnu}/${id}`).set({id,q,a:'',liked:false,createdAt:Date.now()});
          alert('Added to Questions: ' + q);
        }catch(e){ console.error(e); alert('AI unavailable right now. Try again in a bit.'); }
        finally{ deepBtn.disabled=false; deepBtn.textContent=orig; }
      });

      // === AI #2: Mood Reading (auto line under Birthdays) ===
      const moodLine=$('moodLine');
      async function refreshMood(){
        try{
          moodLine.textContent='Loading mood‚Ä¶ (first time may take ~10‚Äì20s)';
          const out=await aiChat("Give a short, warm mood reading or romantic quote for a teenage couple named Vishnu and Thanya. 2‚Äì3 sentences, gentle, wholesome.");
          moodLine.textContent=out;
        }catch(e){ console.error(e); moodLine.textContent='(AI mood unavailable. Will retry soon.)'; }
      }
      // kick once after unlock; then every 30s
      refreshMood(); setInterval(refreshMood, 30000);

      // === AI #3: Love Story (fancy modal with hearts + typing) ===
      const storyBtn=$('aiStoryBtn'), storyModal=$('storyModal'), storyBody=$('storyBody'), storyClose=$('storyClose'), storyCard=$('storyCard');
      function openStoryModal(){ storyModal.style.display='flex'; }
      function closeStoryModal(){ storyModal.style.display='none'; }
      $('storyClose').addEventListener('click', closeStoryModal);
      storyModal.addEventListener('click', (e)=>{ if(e.target===storyModal) closeStoryModal(); });

      function spawnFloatHearts(){
        for(let i=0;i<8;i++){
          const h=document.createElement('div'); h.className='float-heart'; h.textContent=['üíó','üíû','üíñ','üíò'][Math.floor(Math.random()*4)];
          h.style.left=(10+Math.random()*80)+'%'; h.style.top=(70+Math.random()*20)+'%'; storyCard.appendChild(h);
          setTimeout(()=>h.remove(),2400);
        }
      }
      function typeInto(element,text,delay=18){
        element.textContent=''; let i=0;
        return new Promise(res=>{
          const t=setInterval(()=>{ element.textContent+=text[i++]||''; if(i>=text.length){ clearInterval(t); res(); } },delay);
        });
      }
      if(storyBtn) storyBtn.addEventListener('click', async ()=>{
        openStoryModal(); storyBody.textContent='Summoning a tiny poet‚Ä¶';
        try{
          const setting=$('tlTitle')?.value?.trim() || "a dreamy evening under pastel skies";
          const story=await aiChat(`Write a short, cute, magical romantic story about Vishnu and Thanya in ${setting}. 6‚Äì10 sentences, soft and wholesome.`);
          storyBody.textContent=''; spawnFloatHearts(); await typeInto(storyBody, story, 14); spawnFloatHearts();
          // Save to notes for posterity
          const id=firebase.database().ref(PATH.notes).push().key;
          await firebase.database().ref(`${PATH.notes}/${id}`).set({id,author:"Vishnu",text:`üìñ AI Love Story:\n${story}`,secret:false,liked:false,pinned:false,createdAt:Date.now()});
        }catch(e){ console.error(e); storyBody.textContent='AI is shy right now. Please try again.'; }
      });

      // ====== Diagnostics ======
      (function selfTest(){
        const results=[]; const sample='a\n b';
        results.push(['regex newline replace', sample.replace(/\n/g,'<br>').includes('<br>')]);
        results.push(['toHTML escapes < and >', toHTML('<b>hi</b>').includes('&lt;b&gt;')]);
        results.push(['firebase SDK present', typeof window.firebase !== 'undefined']);
        results.push(['stars canvas exists', !!$('stars')]);
        results.push(['widgets exist', !!$('widgets')]);
        results.push(['datesGrid exists', !!$('datesGrid')]);
        results.push(['bucketList exists', !!$('bucketList')]);
        results.push(['photoGrid exists', !!$('photoGrid')]);
        results.push(['notesList exists', !!$('notesList')]);
        results.push(['timeline exists', !!$('timeline')]);
        console.table(results.map(([k,v])=>({test:k, pass:!!v})));
      })();
    }
  </script>
</body>
</html>

