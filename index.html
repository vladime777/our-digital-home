<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Our Little Digital Home ‚Äî Final (Passcode + Realtime DB)</title>
  <style>
    :root{
      --sky:#dff4ff; --peach:#ffe2d2; --pink:#ffd7e9; --cream:#fff9f2; --paper:#ffffff;
      --muted:#6b6b6b; --vishnu-pink:#ffd1e6; --thanya-blue:#cfefff;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html{scroll-behavior:smooth}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,var(--sky),var(--peach),var(--pink),var(--cream)); color:#222; overflow-x:hidden}

    /* Loader */
    #loader{position:fixed; inset:0; background:linear-gradient(180deg,var(--sky),var(--peach),var(--pink),var(--cream)); display:flex; align-items:center; justify-content:center; z-index:9990}
    @keyframes pulseHeart{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}
    .heart{width:84px; height:84px; background:pink; position:relative; transform:rotate(-45deg); animation:pulseHeart 1.1s infinite}
    .heart:before,.heart:after{content:""; position:absolute; background:pink; width:84px; height:84px; border-radius:50%}
    .heart:before{top:-42px}
    .heart:after{left:42px}
    .fade-out{animation: fadeOut 0.8s ease forwards}
    @keyframes fadeOut{to{opacity:0; visibility:hidden}}

    /* Lock Screen */
    #lockScreen{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:linear-gradient(180deg,var(--pink),var(--peach),var(--sky))}
    .lock-card{background:rgba(255,255,255,0.7); padding:26px 28px; border-radius:18px; box-shadow:0 10px 28px rgba(0,0,0,0.12); backdrop-filter:blur(10px); text-align:center}
    .lock-card h2{margin-bottom:8px}
    .lock-card input{padding:10px 12px; border-radius:10px; border:1px solid #ccc; font-size:18px; text-align:center; width:160px}
    .lock-card button{margin-top:12px; background:linear-gradient(90deg,var(--sky),var(--pink)); border:none; padding:10px 16px; border-radius:12px; font-weight:600; cursor:pointer}
    .shake{animation:shake .4s}
    @keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-8px)}40%,60%{transform:translateX(8px)}}

    /* Floating Nav */
    #floatNav{position:fixed; top:14px; right:14px; z-index:998; backdrop-filter:blur(10px); background:rgba(255,255,255,0.6); padding:8px 10px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:6px}
    #floatNav a{text-decoration:none; font-size:20px}

    /* Header */
    header{min-height:55vh; display:flex; align-items:center; justify-content:center; padding:40px 20px; text-align:center}
    .welcome-card{background:rgba(255,255,255,0.55); padding:28px; border-radius:22px; max-width:900px; box-shadow:0 8px 24px rgba(0,0,0,0.1)}
    .enter-btn{background:linear-gradient(90deg,var(--sky),var(--pink)); border:none; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:0 8px 14px rgba(0,0,0,0.1)}

    main{padding:22px; max-width:1040px; margin:0 auto 120px}
    section{background:rgba(255,255,255,0.7); padding:18px; border-radius:16px; margin:18px 0; box-shadow:0 6px 16px rgba(0,0,0,0.08)}
    .section-title{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}

    /* Dates */
    .dates-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px}
    .date-card{background:rgba(255,255,255,0.85); padding:12px; border-radius:12px}
    .date-count{font-size:18px; font-weight:700; margin-top:6px}

    /* Bucket */
    .bucket-list{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px}
    .bucket-item{background:rgba(255,255,255,0.9); padding:14px; border-radius:12px; display:flex; gap:10px; align-items:center}
    .bucket-item input[type=checkbox]{width:18px; height:18px}

    /* Scrapbook Polaroid Gallery */
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:10px 0}
    .controls input[type="text"], .controls select{padding:8px; border-radius:8px; border:1px solid #ccc}
    .photo-grid{position:relative; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:22px; padding:8px}
    .polaroid{position:relative; width:100%; aspect-ratio:3/4; background:var(--paper); border-radius:8px; padding:10px 10px 36px; box-shadow:0 10px 30px rgba(0,0,0,.18); transform-origin:center; transition:transform .25s ease, box-shadow .25s ease}
    .polaroid:hover{transform:rotate(var(--rot)) translateY(-6px) scale(1.03); box-shadow:0 16px 40px rgba(0,0,0,.24)}
    .polaroid .imgwrap{position:absolute; inset:10px 10px 44px 10px; overflow:hidden; border-radius:6px; background:linear-gradient(135deg,var(--peach),var(--pink))}
    .polaroid img{width:100%; height:100%; object-fit:cover; display:block}
    .caption{position:absolute; left:10px; right:10px; bottom:10px; height:28px; display:flex; align-items:center; justify-content:center; font-family: 'Comic Sans MS', 'Patrick Hand', system-ui; font-size:13px; color:#333}
    .tape{position:absolute; width:46px; height:18px; background:rgba(255,255,200,.8); box-shadow:0 2px 6px rgba(0,0,0,.15); transform:rotate(var(--trot)); border-radius:3px}
    .tape:after{content:""; position:absolute; inset:0; background:repeating-linear-gradient(90deg, rgba(255,255,255,.3) 0 6px, rgba(0,0,0,.05) 6px 12px); mix-blend-mode:overlay; border-radius:3px}
    .sticker{position:absolute; font-size:18px; filter:drop-shadow(0 2px 2px rgba(0,0,0,.15))}
    .meta{position:absolute; top:8px; right:10px; font-size:11px; color:#666}
    .actions{display:flex; gap:6px; margin-top:6px; flex-wrap:wrap}
    .sm-btn{background:linear-gradient(90deg,var(--sky),var(--pink)); border:none; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,0.08)}

    /* Q&A */
    .q-card{margin-bottom:10px}
    .bubble-q{padding:10px 12px; border-radius:14px; display:inline-block; font-weight:600}
    .bubble-a{margin-top:6px; padding:10px; border-radius:12px; font-size:14px; background:rgba(255,255,255,0.75)}
    .vishnu-bubble{background:var(--vishnu-pink)}
    .thanya-bubble{background:var(--thanya-blue)}

    /* Music */
    .music-toggle{position:fixed; right:18px; bottom:18px; width:56px; height:56px; background:linear-gradient(90deg,var(--sky),var(--pink)); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 12px 32px rgba(0,0,0,0.12); cursor:pointer; z-index:997}

    /* Sparkles */
    .sparkles{position:fixed; inset:0; pointer-events:none}
    .spark{position:absolute; width:8px; height:8px; border-radius:50%; opacity:0.9}

    footer{padding:18px; text-align:center; color:#6b6b6b; font-size:13px}
  </style>
  <!-- Firebase compat SDKs for simplicity in single-file deployment -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Loader -->
  <div id="loader"><div class="heart"></div></div>

  <!-- PASSCODE OVERLAY -->
  <div id="lockScreen">
    <div class="lock-card" id="lockCard">
      <h2>Enter Passcode üíñ</h2>
      <input type="password" id="passInput" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div><button id="unlockBtn">Unlock</button></div>
      <div style="font-size:12px;color:#666;margin-top:8px">Tip: share only with Thanya üíù</div>
    </div>
  </div>

  <!-- Floating Nav -->
  <nav id="floatNav" aria-label="Quick navigation" style="display:none">
    <a href="#dates" title="Dates">üóìÔ∏è</a>
    <a href="#bucket" title="Bucket List">ü™£</a>
    <a href="#gallery" title="Gallery">üì∏</a>
    <a href="#questions" title="Questions">üí¨</a>
    <a href="#notes" title="Notes">üíå</a>
  </nav>

  <div class="sparkles" id="sparkles"></div>

  <header>
    <div class="welcome-card">
      <h1>Our Little Digital Home</h1>
      <p>Heyyyyy my honeybun, welcome to our little digital home üíñüíñ</p>
      <button type="button" class="enter-btn" id="enterBtn">Enter Our World üí´</button>
    </div>
  </header>

  <main id="mainContent" style="display:none">
    <!-- DATES -->
    <section id="dates">
      <div class="section-title"><h2>‚è≥ Moments We're Waiting For</h2></div>
      <div class="dates-grid" id="datesGrid"></div>
      <div class="controls">
        <input id="evName" placeholder="Event name" />
        <input id="evDate" type="date" />
        <button id="addEvent" class="sm-btn">Add</button>
        <button id="clearEvents" class="sm-btn">Clear</button>
      </div>
    </section>

    <!-- BUCKET LIST -->
    <section id="bucket">
      <div class="section-title"><h2>üåü Our Bucket List</h2></div>
      <div class="controls">
        <input id="newBucket" placeholder="Add new dream..." />
        <button id="addBucket" class="sm-btn">Add</button>
      </div>
      <div class="bucket-list" id="bucketList"></div>
    </section>

    <!-- GALLERY (Realtime DB base64 + Polaroids) -->
    <section id="gallery">
      <div class="section-title"><h2>üì∏ Scrapbook Polaroids</h2></div>
      <div class="controls">
        <input type="file" id="photoFile" accept="image/*" />
        <input type="text" id="photoCaption" placeholder="Caption (optional)" />
        <select id="photoAuthor">
          <option value="Vishnu">Vishnu</option>
          <option value="Thanya">Thanya</option>
        </select>
        <button id="uploadBtn" class="sm-btn">Upload</button>
      </div>
      <div class="photo-grid" id="photoGrid"></div>
    </section>

    <!-- Q&A -->
    <section id="questions">
      <div class="section-title"><h2>üí¨ Questions Corner</h2></div>
      <div class="controls">
        <input id="vishnuNew" placeholder="Ask Thanya..." />
        <button id="addVishnu" class="sm-btn">Add</button>
      </div>
      <div id="vishnuQs"></div>

      <div class="controls">
        <input id="thanyaNew" placeholder="Ask Vishnu..." />
        <button id="addThanya" class="sm-btn">Add</button>
      </div>
      <div id="thanyaQs"></div>
    </section>

    <!-- LOVE NOTES (Hybrid) -->
    <section id="notes">
      <div class="section-title"><h2>üíå Love Notes</h2><small style="color:#666">Pink = Vishnu ‚Ä¢ Blue = Thanya</small></div>
      <div class="controls">
        <select id="noteAuthor">
          <option value="Vishnu">Vishnu</option>
          <option value="Thanya">Thanya</option>
        </select>
        <input id="newNoteText" placeholder="Write a sweet note..." />
        <button id="addNote" class="sm-btn">Add</button>
      </div>
      <div id="notesList"></div>
    </section>
  </main>

  <div class="music-toggle" id="musicToggle" title="Play / Pause music">üéµ</div>
  <footer>Made with üíñ for Thanya & Vishnukeerthy ‚Äî Passcode ‚Ä¢ Realtime DB ‚Ä¢ Polaroids</footer>

  <script>
    // ====== Constants ======
    const PASSCODE = "120625"; // Change this anytime

    // ====== Utility helpers ======
    const $ = (id) => document.getElementById(id);
    const toHTML = (text='') => text
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/\n/g,'<br>'); // ‚úÖ correct newline regex

    function hideLoader(){ const ld = $('loader'); if(!ld) return; ld.classList.add('fade-out'); ld.addEventListener('animationend', ()=> ld.remove()); }
    setTimeout(hideLoader, 1200);
    function burstSparkles(xPct,yPct){ const c = $('sparkles'); for(let i=0;i<16;i++){ const s = document.createElement('div'); s.className='spark'; s.style.left=(xPct+(Math.random()*8-4))+'%'; s.style.top=(yPct+(Math.random()*6-3))+'%'; s.style.background=['#FFD1BF','#FFC0D6','#BFE9FF','#FFF7EE'][Math.floor(Math.random()*4)]; c.appendChild(s); const dur=900+Math.random()*700; s.animate([{transform:'translateY(0) scale(1)',opacity:1},{transform:'translateY(-60px) scale(.6)',opacity:0}],{duration:dur,easing:'cubic-bezier(.2,.7,.2,1)'}); setTimeout(()=>s.remove(), dur+40);} }

    // ====== Firebase config (compat) ======
    const firebaseConfig = {
      apiKey: "AIzaSyAH-tY0cqZ38nzTl9Z5VBeLU739v8O3XCA",
      authDomain: "our-digital-home.firebaseapp.com",
      databaseURL: "https://our-digital-home-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "our-digital-home",
      storageBucket: "our-digital-home.appspot.com",
      messagingSenderId: "381695438861",
      appId: "1:381695438861:web:5759fcbb1bb5cbb152e544"
    };

    // ====== Firebase paths ======
    const PATH = {
      events: 'events',
      bucketItems: 'bucket/items',
      bucketState: 'bucket/state',
      qVishnu: 'questions/vishnu',
      qThanya: 'questions/thanya',
      notes: 'notes',
      gallery: 'gallery/items'
    };

    // ====== Passcode gate ======
    $('unlockBtn').addEventListener('click', ()=>{
      const val = $('passInput').value.trim();
      const card = $('lockCard');
      if(val===PASSCODE){
        $('lockScreen').style.display='none';
        document.getElementById('floatNav').style.display='flex';
        initFirebaseAndApp();
      }else{
        card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
      }
    });

    // ====== Music ======
    let audioCtx=null, masterGain=null, osc1=null, playing=false;
    function startMusic(){ if(playing) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.05; masterGain.connect(audioCtx.destination); osc1=audioCtx.createOscillator(); osc1.type='sine'; osc1.frequency.value=220; const osc2=audioCtx.createOscillator(); osc2.type='triangle'; osc2.frequency.value=330; const g2=audioCtx.createGain(); g2.gain.value=0.12; osc1.connect(masterGain); osc2.connect(g2); g2.connect(masterGain); osc1.start(); osc2.start(); playing=true; }
    function stopMusic(){ if(!playing) return; try{osc1.stop()}catch(e){} try{audioCtx.close()}catch(e){} audioCtx=null; masterGain=null; osc1=null; playing=false; }

    // ====== Firebase + App init (after passcode) ======
    function initFirebaseAndApp(){
      // init
      firebase.initializeApp(firebaseConfig);
      const auth=firebase.auth();
      const db=firebase.database();
      let UID=null;

      // UI hooks
      $('musicToggle').addEventListener('click',()=>{ if(!playing){ startMusic(); $('musicToggle').textContent='‚è∏'; } else { stopMusic(); $('musicToggle').textContent='üéµ'; } });
      $('enterBtn').addEventListener('click',()=>{ const main=$('mainContent'); main.style.display='block'; const top=main.offsetTop; window.scrollTo({top, behavior:'smooth'}); });

      // auth
      auth.signInAnonymously().then(res=>{ UID=res.user.uid; startRealtime(); }).catch(err=>{ console.error('Auth failed', err); startRealtime(/*readonly*/); });

      // ====== Realtime features ======
      function startRealtime(){
        // DATES
        function startCountdown(el, iso){ function up(){ const now=new Date(); const t=new Date(iso+'T00:00:00'); const d=t-now; if(d<=0){ el.textContent='Happening now or passed!'; return; } const days=Math.floor(d/86400000); const hrs=Math.floor((d%86400000)/3600000); const mins=Math.floor((d%3600000)/60000); const secs=Math.floor((d%60000)/1000); el.textContent=`${days}d ${hrs}h ${mins}m ${secs}s`; } up(); return setInterval(up,1000);}        
        function renderEventsUI(map){ const grid=$('datesGrid'); grid.innerHTML=''; const arr=Object.entries(map||{}).map(([id,e])=>({id,...e})).sort((a,b)=>(a.date||'').localeCompare(b.date||'')); arr.forEach((e)=>{ const card=document.createElement('div'); card.className='date-card'; card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${toHTML(e.name||'Untitled')}</strong><div class="date-meta" style="font-size:13px;color:#666">${e.date||''}</div></div><button class="sm-btn" data-id="${e.id}" data-act="rm">‚ùå</button></div><div class="date-count" id="count_${e.id}">...</div>`; grid.appendChild(card); const el=$('count_'+e.id); if(el&&e.date) startCountdown(el,e.date); }); }
        $('addEvent').addEventListener('click',()=>{ const name=$('evName').value.trim(); const date=$('evDate').value; if(!name||!date) return alert('Please add both name and date'); const id=db.ref(PATH.events).push().key; db.ref(`${PATH.events}/${id}`).set({id,name,date,createdAt:Date.now()}); $('evName').value=''; $('evDate').value=''; });
        $('clearEvents').addEventListener('click',()=>{ if(confirm('Clear all saved events?')) db.ref(PATH.events).set(null); });
        $('datesGrid').addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-act="rm"]'); if(!btn) return; const id=btn.dataset.id; db.ref(`${PATH.events}/${id}`).remove(); });
        db.ref(PATH.events).on('value',snap=>{ const data=snap.val()||{}; if(Object.keys(data).length===0){ const id=db.ref(PATH.events).push().key; db.ref(`${PATH.events}/${id}`).set({id,name:'Our Anniversary üíû',date:'2026-02-14',createdAt:Date.now()}); } else { renderEventsUI(data); } });

        // BUCKET
        function renderBucketUI(itemsMap, stateMap){ const c=$('bucketList'); c.innerHTML=''; const arr=Object.entries(itemsMap||{}).map(([id,it])=>({id,...it})); arr.forEach(it=>{ const div=document.createElement('div'); div.className='bucket-item'; const checked=!!(stateMap&&stateMap[it.id]); div.innerHTML=`<div style="font-size:22px">${it.emoji||'‚ú®'}</div><label style="display:flex;align-items:center;gap:10px;flex:1"><input type="checkbox" data-id="${it.id}" ${checked?'checked':''}><div><strong>${toHTML(it.text||'')}</strong><div style="font-size:12px;color:#666">Click to mark done</div></div></label>`; c.appendChild(div); }); c.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.addEventListener('change',(e)=>{ const id=e.target.dataset.id; const checked=e.target.checked; db.ref(PATH.bucketState).update({[id]:checked}); if(checked) burstSparkles(50,40); }); }); }
        $('addBucket').addEventListener('click',()=>{ const inp=$('newBucket'); const val=inp.value.trim(); if(!val) return; const id=db.ref(PATH.bucketItems).push().key; db.ref(`${PATH.bucketItems}/${id}`).set({id,emoji:'‚ú®',text:val,createdAt:Date.now()}); inp.value=''; });
        db.ref(PATH.bucketItems).on('value',snap=>{ const items=snap.val(); if(!items){ [{emoji:'üê†',text:'Aquarium date'},{emoji:'üç≥',text:'Make food together'},{emoji:'üè∫',text:'Pottery date'},{emoji:'üêà',text:'Get a Bengal cat'}].forEach(d=>{ const id=db.ref(PATH.bucketItems).push().key; db.ref(`${PATH.bucketItems}/${id}`).set({id,...d,createdAt:Date.now()}); }); } });
        db.ref(PATH.bucketItems).on('value',itemsSnap=>{ const items=itemsSnap.val()||{}; db.ref(PATH.bucketState).on('value',stateSnap=>{ renderBucketUI(items,stateSnap.val()||{}); }); });

        // GALLERY (DB base64)
        function randomBetween(a,b){ return a + Math.random()*(b-a); }
        function polaroidNode(item){ const wrap=document.createElement('div'); wrap.className='polaroid'; const rot=(randomBetween(-6,6).toFixed(2)+'deg'); wrap.style.setProperty('--rot',rot); // tapes
          [{x:14,y:-8,r:-8},{x:60,y:-10,r:8},{x:40,y:-10,r:2}].forEach(t=>{ const tp=document.createElement('div'); tp.className='tape'; tp.style.left=t.x+'px'; tp.style.top=t.y+'px'; tp.style.setProperty('--trot', t.r+'deg'); wrap.appendChild(tp); }); const stickers=['‚ú®','üíò','‚≠ê','üíñ','üå∏','ü©∑','üí´']; const sk=document.createElement('div'); sk.className='sticker'; sk.textContent=stickers[Math.floor(Math.random()*stickers.length)]; sk.style.left=randomBetween(8,70)+'%'; sk.style.top=randomBetween(6,20)+'%'; wrap.appendChild(sk); const imgw=document.createElement('div'); imgw.className='imgwrap'; const img=new Image(); img.src=item.data; img.alt=item.caption||'Our photo'; imgw.appendChild(img); wrap.appendChild(imgw); const cap=document.createElement('div'); cap.className='caption'; cap.textContent=item.caption||''; wrap.appendChild(cap); const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${item.author||''} ‚Ä¢ ${new Date(item.time||Date.now()).toLocaleDateString()}`; wrap.appendChild(meta); if(item.uid===UID){ const actions=document.createElement('div'); actions.className='actions'; const del=document.createElement('button'); del.className='sm-btn'; del.textContent='Delete'; del.addEventListener('click',()=>{ if(confirm('Delete this photo?')) db.ref(`${PATH.gallery}/${item.id}`).remove(); }); actions.appendChild(del); wrap.appendChild(actions);} wrap.style.opacity='0'; wrap.style.transform=`rotate(${rot}) scale(.98)`; requestAnimationFrame(()=>{ wrap.style.transition='transform .35s ease, opacity .35s ease, box-shadow .35s ease'; wrap.style.opacity='1'; wrap.style.transform=`rotate(${rot}) scale(1)`; }); return wrap; }
        function handleUpload(){ const file=$('photoFile').files[0]; if(!file) return alert('Pick a photo'); const caption=$('photoCaption').value.trim(); const author=$('photoAuthor').value || 'Vishnu'; const reader=new FileReader(); reader.onload=()=>{ const base64=reader.result; const id=db.ref(PATH.gallery).push().key; db.ref(`${PATH.gallery}/${id}`).set({ id, data:base64, caption, author, uid:UID, time:Date.now() }); $('photoFile').value=''; $('photoCaption').value=''; }; reader.readAsDataURL(file); }
        $('uploadBtn').addEventListener('click', handleUpload);
        db.ref(PATH.gallery).on('value',snap=>{ const grid=$('photoGrid'); grid.innerHTML=''; const items=Object.entries(snap.val()||{}).map(([id,it])=>({id,...it})).sort((a,b)=> (b.time||0)-(a.time||0)); items.forEach(it=> grid.appendChild(polaroidNode(it))); });

        // QUESTIONS
        function renderQsList(key, containerId){ db.ref(key).on('value',snap=>{ const c=$(containerId); c.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,q])=>({id,...q})).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)); arr.forEach(obj=>{ const wrap=document.createElement('div'); wrap.className='q-card'; const isV = key===PATH.qVishnu; const qB=document.createElement('div'); qB.className='bubble-q '+(isV?'vishnu-bubble':'thanya-bubble'); qB.textContent=obj.q; const aB=document.createElement('div'); aB.className='bubble-a'; aB.textContent=obj.a||''; const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px'; const ansBtn=document.createElement('button'); ansBtn.textContent=obj.a? 'Edit Answer':'Answer'; ansBtn.className='sm-btn'; const del=document.createElement('button'); del.textContent='Delete'; del.className='sm-btn'; const like=document.createElement('button'); like.textContent=obj.liked?'‚ù§Ô∏è':'ü§ç'; like.className='sm-btn'; ansBtn.addEventListener('click',()=>{ const ta=document.createElement('textarea'); ta.style.width='100%'; ta.style.minHeight='60px'; ta.value=obj.a||''; const saveBtn=document.createElement('button'); saveBtn.textContent='Save'; saveBtn.className='sm-btn'; saveBtn.style.marginTop='6px'; aB.innerHTML=''; aB.appendChild(ta); aB.appendChild(saveBtn); saveBtn.addEventListener('click',()=>{ db.ref(`${key}/${obj.id}`).update({a:ta.value}); }); }); del.addEventListener('click',()=> db.ref(`${key}/${obj.id}`).remove()); like.addEventListener('click',()=> db.ref(`${key}/${obj.id}`).update({liked: !obj.liked})); row.appendChild(ansBtn); row.appendChild(like); row.appendChild(del); wrap.appendChild(qB); wrap.appendChild(aB); wrap.appendChild(row); c.appendChild(wrap); }); }); }
        $('addVishnu').addEventListener('click',()=>{ const val=$('vishnuNew').value.trim(); if(!val) return; const id=db.ref(PATH.qVishnu).push().key; db.ref(`${PATH.qVishnu}/${id}`).set({id,q:val,a:'',liked:false,createdAt:Date.now()}); $('vishnuNew').value=''; });
        $('addThanya').addEventListener('click',()=>{ const val=$('thanyaNew').value.trim(); if(!val) return; const id=db.ref(PATH.qThanya).push().key; db.ref(`${PATH.qThanya}/${id}`).set({id,q:val,a:'',liked:false,createdAt:Date.now()}); $('thanyaNew').value=''; });
        renderQsList(PATH.qVishnu,'vishnuQs');
        renderQsList(PATH.qThanya,'thanyaQs');

        // LOVE NOTES
        function renderNotes(){ db.ref(PATH.notes).on('value',snap=>{ const list=$('notesList'); list.innerHTML=''; const arr=Object.entries(snap.val()||{}).map(([id,n])=>({id,...n})); arr.sort((a,b)=> (b.pinned===true?1:0)-(a.pinned===true?1:0) || (b.createdAt||0)-(a.createdAt||0)); arr.forEach(n=>{ const card=document.createElement('div'); const bg=n.author==='Vishnu'?'rgba(255,209,230,0.9)':'rgba(207,239,255,0.9)'; Object.assign(card.style,{background:bg,padding:'12px',borderRadius:'16px',marginBottom:'10px',boxShadow:'0 4px 12px rgba(0,0,0,0.08)',position:'relative',transition:'0.3s ease'}); card.onmouseenter=()=>{ card.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'; }; card.onmouseleave=()=>{ card.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'; }; const safeText=toHTML(n.text||''); card.innerHTML=`<div style="display:flex; align-items:center; gap:8px; margin-bottom:6px"><div style="font-size:20px">${n.author==='Vishnu'?'ü©∑':'üíô'}</div><strong>${n.author||''}</strong><span style="font-size:12px; color:#555">‚Ä¢ ${new Date(n.createdAt||Date.now()).toLocaleString()}</span></div><div style="margin:4px 0 8px; white-space:pre-wrap">${safeText}</div><div class="note-actions" style="display:flex;gap:8px;margin-top:6px; flex-wrap:wrap"><button class="sm-btn" data-act="pin" data-id="${n.id}">${n.pinned? 'üìå Pinned':'üìç Pin'}</button><button class="sm-btn" data-act="like" data-id="${n.id}">${n.liked?'‚ù§Ô∏è':'ü§ç'}</button><button class="sm-btn" data-act="del" data-id="${n.id}">Delete</button></div>`; card.style.opacity=0; card.style.transform='translateY(10px)'; list.appendChild(card); requestAnimationFrame(()=>{ card.style.transition='0.4s ease'; card.style.opacity=1; card.style.transform='translateY(0)'; }); }); }); }
        $('addNote').addEventListener('click',()=>{ const author=$('noteAuthor').value; const text=$('newNoteText').value.trim(); if(!text) return; const id=db.ref(PATH.notes).push().key; db.ref(`${PATH.notes}/${id}`).set({id,author,text,liked:false,pinned:false,createdAt:Date.now()}); $('newNoteText').value=''; });
        $('notesList').addEventListener('click',(e)=>{ const btn=e.target.closest('button[data-act]'); if(!btn) return; const act=btn.dataset.act; const id=btn.dataset.id; const r=db.ref(`${PATH.notes}/${id}`); if(act==='del'){ r.remove(); return; } r.once('value',snap=>{ const cur=snap.val(); if(!cur) return; if(act==='like'){ r.update({liked: !cur.liked}); } if(act==='pin'){ r.update({pinned: !cur.pinned}); } }); });
        renderNotes();

        // show main/nav
        $('floatNav').style.display='flex';
        $('mainContent').style.display='block';
      }

      // Diagnostics
      selfTest();
    }

    // ====== Diagnostics ======
    function selfTest(){
      const results=[];
      // ‚úÖ fixed regex tests
      const sample = 'a\n b';
      results.push(['regex newline replace', sample.replace(/\n/g,'<br>').includes('<br>')]);
      results.push(['toHTML escapes < and >', toHTML('<b>hi</b>').includes('&lt;b&gt;')]);
      results.push(['datesGrid exists', !!$('datesGrid')]);
      results.push(['bucketList exists', !!$('bucketList')]);
      results.push(['photoGrid exists', !!$('photoGrid')]);
      results.push(['notesList exists', !!$('notesList')]);
      console.table(results.map(([k,v])=>({test:k, pass:!!v})));
    }
  </script>
</body>
</html>

